{
  "Name": "/insightgym/run_sh_script",
  "Value": "#!/bin/bash\nset -e\nREGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)\nACCOUNT=$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | sed -n 's/.*\"accountId\" *: *\"\\([^\"]*\\)\".*/\\1/p')\nREPO=insightgym\nIMAGE=\"${ACCOUNT}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:latest\"\naws ecr get-login-password --region \"$REGION\" | docker login --username AWS --password-stdin \"${ACCOUNT}.dkr.ecr.${REGION}.amazonaws.com\"\ndocker pull \"$IMAGE\" || true\nDATABASE_URL=$(aws ssm get-parameter --name /insightgym/DATABASE_URL --with-decryption --query Parameter.Value --output text --region \"$REGION\" 2>/dev/null || echo \"\")\nJWT_SECRET_KEY=$(aws ssm get-parameter --name /insightgym/JWT_SECRET_KEY --with-decryption --query Parameter.Value --output text --region \"$REGION\" 2>/dev/null || echo \"\")\nif [ -z \"$DATABASE_URL\" ] || [ -z \"$JWT_SECRET_KEY\" ]; then\n  echo \"Missing SSM params\"\n  exit 1\nfi\ndocker stop insightgym 2>/dev/null || true\ndocker rm insightgym 2>/dev/null || true\ndocker run -d --name insightgym --restart unless-stopped -p 8080:8080 -e DATABASE_URL=\"$DATABASE_URL\" -e JWT_SECRET_KEY=\"$JWT_SECRET_KEY\" -e FLASK_ENV=production \"$IMAGE\"\n",
  "Type": "String",
  "Overwrite": true
}
